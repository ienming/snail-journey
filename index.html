<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="dist/main.css">
    <style>
        #userState{
            position: fixed;
            left: 0;
            top: 0;
            z-index: 97;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Header -->
        <my-header @switch-personalpage="switchPersonalPage"></my-header>
        <!-- 測試使用者狀態 -->
        <div id="userState">
            <h3>User State:</h3>
            <ul>
                <li v-for="(el,idx) of user.missions"><span>{{idx}}: </span> {{ el }}</li>
            </ul>
            <ul>
                <p>Achievements</p>
                <li v-for="(el, idx) of user.achievements"><span>{{idx}}: </span>{{el}}</li>
                <span>{{userGotAchievements}}</span>
            </ul>
        </div>
        <!-- 進場動畫 -->
        <transition name="fade">
            <div id="loading" v-if="interaction.nowLoading">
                <div class="wrapper">
                    <h1 @click="startGame">START</h1>
                </div>
            </div>
        </transition>
        <!-- 主要遊戲畫面 -->
        <div id="canvasContainer"></div>
        <!-- Personal Page -->
        <transition name="fade">
            <personal-page v-if="interaction.showPersonalPage" :user-got-badges="userGotBadges" :user-got-achievements="userGotAchievements" :outer-show-personal-page="interaction.showPersonalPage" @switch-personal-page="switchPersonalPage"></personal-page>
        </transition>
        <!-- popup 對話框 -->
        <transition name="fade">
            <div class="mock" v-show="interaction.showPopup">
                <div class="wrapper">
                    <div id="imgCanvasContainer" v-show="animatedSpriteSpeak"></div>
                    <div v-show="!animatedSpriteSpeak" class="mr-2" id="imgStaticContainer">
                        <img :src="itemSpeakImgSrc" alt="">
                    </div>
                    <div class="popup">
                        <!-- 不管怎樣都會有的見面招呼語 -->
                        <div>
                            <p v-if="nowSpeak == undefined">
                                This is {{ itemSpeak }} speaking
                            </p>
                            <div class="game-ui">
                                <!-- 有選項時的按鈕 -->
                                <div v-if="showMissionBtn">
                                    <button v-for="btn of missionBtns" @click="checkAns(btn.correct);">{{btn.option}}</button>
                                </div>
                                <div v-else>
                                    <p>
                                        <p>{{ nowSpeak }}</p>
                                    </p>
                                    <button @click="pureNext" v-show="btnTxt">{{btnTxt}}</button>
                                </div>
                            </div>
                        </div>
                        <!-- 有認養行動案就顯示 -->
                        <button v-if="adoptable" @click="switchProgram">認養行動案:{{program.name}}</button>
                        <!-- 跳轉到行動案的視窗 -->
                        <div v-if="showProgram">
                            <p>認養行動案：{{program.name}}</p>
                            <p>{{program.description}}</p>
                            <form action="">
                                <p>表單測試</p>
                                <input type="text" />
                            </form>
                        </div>
                        <!-- Close Button -->
                        <close-btn :outer-show-popup="interaction.showPopup" @switch-popup="switchPopup"></close-btn>
                    </div>
                </div>
            </div>
        </transition>
    </div>
    
    <!-- Vue -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <!-- PIXI -->
    <script src="https://pixijs.download/release/pixi.js"></script>
    <script src="https://unpkg.com/@pixi/sound/dist/pixi-sound.js"></script>
    <!-- GSAP -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.js' integrity='sha512-1KGTH8Epj8H43YrKn130fyDzVvNn2YMoyYy6TmF2tgemLZ4sfSoAxRSPq9li4BKHdoON4GwwQUMPL2gFreHSbw==' crossorigin='anonymous'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/PixiPlugin.min.js" integrity="sha512-sSYM7MQVTmI4X9VmroJBmkixnxxX6TFRKfzXgFg7PXWz7VeYwGgEeqK7cVRZPFw30sjH3aZOhiwLv6ObJpoWRg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Custom -->
    <script type="module" src="dist/main.js"></script>
    <script src="src/js/components/PersonalPage.js"></script>
    <script src="src/js/components/CloseBtn.js"></script>
    <script src="src/js/components/Header.js"></script>
    <script>
        const vm = new Vue({
            el: "#app",
            data: {
                animatedSpriteSpeak: false,
                interaction: {
                    nowClicked: false,
                    nowLoading: true,
                    showPopup: false,
                    showPersonalPage: false,
                    nowAns: true
                },
                adoptable: false,
                program: undefined,
                showProgram: false,
                showMissionBtn: false,
                btnTxt: "關閉",
                nowSpeak: undefined,
                itemSpeak: undefined,
                nowNPC: undefined,
                achievementMap: {
                    block1: ['bike'],
                    block2: ['board', 'house_cinemaroll'],
                    block3: ['house_literature']
                },
                user: {
                    missions: {
                        mission1: [],
                        mission2: [],
                        mission3: [],
                    },
                    achievements: {
                        block1: [],
                        block2: [],
                        block3: []
                    }
                },
            },
            computed: {
                itemSpeakImgSrc(){
                    if (this.itemSpeak !== undefined){
                        if (!this.animatedSpriteSpeak){
                            return `src/img/${this.itemSpeak}.png`
                        }
                    }
                },
                finishedProgress(){
                    if (this.nowNPC){
                        return this.user.missions[`mission${this.nowNPC.mission}`].length
                    }else return
                },
                userGotBadges(){
                    let badges = {
                        mission1: false,
                        mission2: false,
                        mission3: false
                    }
                    for (let prop in this.user.missions){
                        if (this.user.missions[prop].indexOf('finished') !== -1){
                            badges[prop] = true
                        }
                    }
                    return badges
                },
                userGotAchievements(){
                    let output = {}
                    let maps = 0
                    for (prop in this.achievementMap){
                        maps ++
                    }
                    for (let i=0; i<maps; i++){
                        let map = this.achievementMap[`block${i+1}`]
                        let userGotArr = this.user.achievements[`block${i+1}`]
                        if (userGotArr.length > 0){
                            if (map.length == userGotArr.length && map.every(val => userGotArr.includes(val))){
                                output[`block${i+1}`] = `探索玩區域${i+1}了！`
                            }else{
                                output[`block${i+1}`] = `尚未探索玩區域${i+1}`
                            }
                        }else{
                            output[`block${i+1}`] = `區域${i+1}尚未開始`
                        }
                    }
                    return output
                },
                missionBtns(){
                    if (this.showMissionBtn){
                        let btns = this.showMissionBtn.split("+") //包有多個選項內容的陣列
                        let arr = []
                        btns.forEach(btn=>{
                            let obj = {}
                            if (btn.indexOf("Y") !== -1){ //確認是不是對的選項
                                obj.option = btn.slice(-btn.length, -1)
                                obj.correct = true
                            }else{
                                obj.option = btn
                            }
                            arr.push(obj)
                        })
                        return arr
                    }else return
                }
            },
            created(){
                //任務資料
                let missionRecorded = JSON.parse(localStorage.getItem('missions'))
                if (missionRecorded){ //如果有已經儲存的任務資料
                    this.user.missionRecorded = missionRecorded //放到 Vue 裏面
                    for (prop in missionRecorded){
                        this.user.missions[prop] = missionRecorded[prop] // 讓前臺拉出紀錄同步，所以遊戲可以進行
                    }
                }
                //區塊發現成就資料
                let achievementRecorded = JSON.parse(localStorage.getItem('achievements'))
                if (achievementRecorded){ //如果有已經儲存的任務資料
                    this.user.achievementRecorded = achievementRecorded //放到 Vue 裏面
                    for (prop in achievementRecorded){
                        this.user.achievements[prop] = achievementRecorded[prop] // 讓前臺拉出紀錄同步，所以遊戲可以進行
                    }
                }
                console.log('missionRecorded: ')
                console.log(missionRecorded)
                console.log('achievementRecorded: ')
                console.log(achievementRecorded)
            },
            mounted() {
                console.log("vue completed load")
            },
            watch: {
                'user.missions': {
                    handler: function(newValue, oldValue){
                        for (prop in newValue){
                            if (newValue[prop].join().indexOf("finished") !== -1){
                                console.log("任務資料完成的變動，開始儲存")
                                let d = JSON.stringify(newValue)
                                console.log('d: '+d)
                                this.storageData('missions', d)
                            }
                        }
                    },
                    deep: true
                },
                'user.achievements': {
                    handler: function(newValue, oldValue){
                        console.log("區塊發現資料有變動，開始儲存")
                        let d = JSON.stringify(newValue)
                        console.log('d: '+d)
                        this.storageData('achievements', d)
                    },
                    deep: true
                }
            },
            methods: {
                switchPopup(){
                    this.interaction.showPopup = !this.interaction.showPopup
                    //如果點到講廢話的NPC然後關閉視窗
                    if (this.nowNPC.enterGame !== 1 && this.user.achievements[`block${this.nowNPC.mission}`].indexOf(this.nowNPC.name) == -1){
                            this.user.achievements[`block${this.nowNPC.mission}`].push(this.nowNPC.name)
                    }
                    //如果遊戲講話到一半的NPC被關閉
                    if (this.nowNPC.enterGame == 1 && this.finishedProgress + 1 < this.nowNPC.gameSpeaks.length){
                        this.user.missions[`mission${this.nowNPC.mission}`] = []
                    }
                    window.setTimeout(()=>{
                        this.showProgram = false
                        this.animatedSpriteSpeak = false
                    }, 100)
                },
                switchPersonalPage(){
                    this.interaction.showPersonalPage = !this.interaction.showPersonalPage
                },
                switchProgram(){
                    this.showProgram = true
                },
                startGame(){
                    this.interaction.nowLoading = false
                },
                checkAns(correct){
                    if (correct){
                        this.pureNext()
                        this.interaction.nowAns = true
                    }else{
                        this.nowSpeak = this.nowNPC.gameSpeakN
                        this.btnTxt = "關閉"
                        this.showMissionBtn = undefined
                        this.interaction.nowAns = false
                    }
                },
                pureNext(){
                    if (!this.interaction.nowAns){ //已經答錯了，要關閉視窗
                        this.switchPopup()
                        return
                    }
                    // 以下是正常運作對話進度
                    if (this.nowNPC.gameSpeaks){
                        if (this.user.missions[`mission${this.nowNPC.mission}`].indexOf('finished') == -1){
                            if (this.finishedProgress + 1 < this.nowNPC.gameSpeaks.length){// 判斷對話結束了沒
                                this.user.missions[`mission${this.nowNPC.mission}`].push(this.nowNPC.name) //推進到下一步
                                if (this.nowNPC.gameOptions[this.finishedProgress]){ // 判斷目前的進展有沒有遊戲選項
                                    this.showMissionBtn = this.nowNPC.gameSpeaks[this.finishedProgress]
                                }else{
                                    // 顯示對話內容
                                    this.nowSpeak = this.nowNPC.gameSpeaks[this.finishedProgress]
                                    this.showMissionBtn = undefined
                                }
                                if (this.finishedProgress + 1 == this.nowNPC.gameSpeaks.length){// 判斷是不是倒數
                                    this.btnTxt = "關閉"
                                }
                            }else if (this.finishedProgress + 1 == this.nowNPC.gameSpeaks.length){ //正要結束
                                this.user.missions[`mission${this.nowNPC.mission}`].push('finished') //記錄結束
                                this.switchPopup()
                                console.log(`完成任務${this.nowNPC.mission}！`)
                                this.user.achievements[`block${this.nowNPC.mission}`].push(this.nowNPC.name)
                            }
                        }else this.switchPopup()
                    }else{ //廢話黨
                        if (this.user.achievements[`block${this.nowNPC.mission}`].indexOf(this.nowNPC.name) == -1){
                            this.user.achievements[`block${this.nowNPC.mission}`].push(this.nowNPC.name)
                        }
                        this.switchPopup()
                    }
                },
                storageData(key, value){
                    localStorage.setItem(key, value)
                }
            }
        })
    </script>
    <!-- popup image canvas -->
    <script>
        // init
        let imgCanvasContainer = document.querySelector("#imgCanvasContainer")
        let imgCanvasApp = new PIXI.Application({
            backgroundColor: 0x000000,
            antialias: true,
            backgroundAlpha: 0
        })
        imgCanvasApp.renderer.resize(300, 300)
        imgCanvasContainer.appendChild(imgCanvasApp.view)

        // animatedSprite
        imgCanvasApp.loader.add('spritesheet', 'src/img/sprite/snail_floor.json')
            .load(onAssetsLoaded)

        function onAssetsLoaded(){
            let uiContainer = new PIXI.Container()
            let uiTextures = []

            let uiBaseTexture = new PIXI.Texture.from(`src/img/sprite/snail_floor_color.png`)
            let uiBase = new PIXI.Sprite(uiBaseTexture)
            uiBase.anchor.set(0.5)
            uiBase.x = 155
            uiBase.y = 150

            for (let i=0; i< 4; i++){
                let texture = PIXI.Texture.from(`snail_floor_${i + 1}.png`)
                uiTextures.push(texture)
            }

            ui = new PIXI.AnimatedSprite(uiTextures)
            ui.anchor.set(0.5)
            ui.x = 150
            ui.y = 150
            ui.animationSpeed = .03
            ui.play()

            uiContainer.addChild(uiBase)
            uiContainer.addChild(ui)

            imgCanvasApp.stage.addChild(uiContainer)

            let counter = 0
            let v = 0.1
            imgCanvasApp.ticker.add(()=>{
                uiContainer.x -= v
                counter ++
                if (counter > 300){
                    v *= -1
                    counter = 0
                }
            })
        }
    </script>
</body>
</html>